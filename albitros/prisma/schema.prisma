// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum CompanySize {
  SMALL
  MEDIUM
  LARGE
}

enum AnnualClaimsVolume {
  UNDER_10K
  BETWEEN_10K_50K
  BETWEEN_50K_100K
  BETWEEN_100K_500K
  OVER_500K
}

enum UserRole {
  ADMIN
  MEMBER
  VIEWER
}

// Healthcare specific enums
enum ClaimStatus {
  PENDING
  APPROVED
  REJECTED
  UNDER_REVIEW
  FLAGGED_FOR_FRAUD
  PAID
}

enum FraudType {
  PHANTOM_BILLING
  UPDATING
  UNBUNDLING
  DUPLICATE_CLAIM
  KICKBACKS
  UNNECESSARY_SERVICES
  MISREPRESENTED_SERVICES
  ORGANIZED_FRAUD
}

enum ProviderType {
  PHYSICIAN
  HOSPITAL
  CLINIC
  LABORATORY
  DURABLE_MEDICAL_EQUIPMENT
  AMBULANCE
  PHARMACY
  THERAPIST
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum InvestigationStatus {
  NEW
  ASSIGNED
  IN_PROGRESS
  AWAITING_RESPONSE
  RESOLVED
  CLOSED
}

model Company {
  id           String              @id @default(cuid())
  name         String
  size         CompanySize?
  claimsVolume AnnualClaimsVolume?
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  users       User[]
  invitations Invitation[]
  auditLogs   AuditLog[]
  providers   Provider[]
  claims      Claim[]
  investigations Investigation[]

  @@map("companies")
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  fullName     String
  role         UserRole @default(MEMBER)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  sentInvitations Invitation[] @relation("SentInvitations")
  auditLogs       AuditLog[]
  createdInvestigations Investigation[] @relation("InvestigationCreator")
  assignedInvestigations Investigation[] @relation("InvestigationAssignee")
  investigationNotes InvestigationNote[]

  @@map("users")
}

model Invitation {
  id        String   @id @default(cuid())
  email     String
  role      UserRole @default(MEMBER)
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  invitedById String?
  invitedBy   User?   @relation("SentInvitations", fields: [invitedById], references: [id])

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("invitations")
}

model AuditLog {
  id        String   @id @default(cuid())
  action    String
  details   Json?
  userId    String?
  companyId String?
  createdAt DateTime @default(now())

  user    User?    @relation(fields: [userId], references: [id])
  company Company? @relation(fields: [companyId], references: [id])

  @@map("audit_logs")
}

// Healthcare Provider Model
model Provider {
  id              String        @id @default(cuid())
  npi             String        @unique // National Provider Identifier
  firstName       String
  lastName        String
  specialty       String?
  providerType    ProviderType
  licenseNumber   String?
  licenseState    String?
  phoneNumber     String?
  email           String?
  address         String?
  city            String?
  state           String?
  zipCode         String?
  latitude        Float?
  longitude       Float?
  
  // Fraud risk metrics
  riskScore       Float         @default(0)
  riskLevel       RiskLevel     @default(LOW)
  totalClaims     Int           @default(0)
  flaggedClaims   Int           @default(0)
  totalBilled     Decimal       @default(0)
  totalPaid       Decimal       @default(0)
  
  isActive        Boolean       @default(true)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  companyId       String
  company         Company       @relation(fields: [companyId], references: [id])
  claims          Claim[]
  investigations  Investigation[] @relation("ProviderInvestigations")
  fraudAlerts     FraudAlert[]
  networkAsProvider1 ProviderNetwork[] @relation("ProviderNetwork1")
  networkAsProvider2 ProviderNetwork[] @relation("ProviderNetwork2")

  @@map("providers")
}

// Patient Model
model Patient {
  id            String   @id @default(cuid())
  mrn           String   @unique // Medical Record Number
  firstName     String
  lastName      String
  dateOfBirth   DateTime
  gender        String?
  phoneNumber   String?
  email         String?
  address       String?
  city          String?
  state         String?
  zipCode       String?
  insuranceId   String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  claims        Claim[]
  
  @@map("patients")
}

// Claim Model - Core fraud detection entity
model Claim {
  id                    String       @id @default(cuid())
  claimNumber           String       @unique
  patientId             String
  providerId            String
  companyId             String
  
  // Claim details
  serviceDate           DateTime
  submissionDate        DateTime     @default(now())
  billedAmount          Decimal
  paidAmount            Decimal?     @default(0)
  status                ClaimStatus  @default(PENDING)
  
  // Fraud detection metrics
  riskScore             Float        @default(0)
  riskLevel             RiskLevel    @default(LOW)
  fraudProbability      Float        @default(0)
  isFlagged             Boolean      @default(false)
  fraudTypes            FraudType[]
  
  // Processing timestamps
  reviewedAt            DateTime?
  approvedAt            DateTime?
  paidAt                DateTime?
  
  // Audit and investigation
  investigationRequired Boolean      @default(false)
  
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt

  patient               Patient      @relation(fields: [patientId], references: [id])
  provider              Provider     @relation(fields: [providerId], references: [id])
  company               Company      @relation(fields: [companyId], references: [id])
  investigations        Investigation[] @relation("ClaimInvestigations")
  claimLineItems        ClaimLineItem[]
  fraudAlerts           FraudAlert[]
  auditLogs             ClaimAuditLog[]

  @@map("claims")
}

// Claim Line Items (CPT/HCPCS codes)
model ClaimLineItem {
  id              String   @id @default(cuid())
  claimId         String
  procedureCode   String   // CPT/HCPCS code
  modifier1       String?
  modifier2       String?
  modifier3       String?
  modifier4       String?
  description     String?
  units           Int      @default(1)
  unitCost        Decimal
  totalCost       Decimal
  diagnosisCode1  String?  // ICD-10 codes
  diagnosisCode2  String?
  diagnosisCode3  String?
  diagnosisCode4  String?
  
  // Fraud detection flags
  isUnbundled     Boolean  @default(false)
  isUpcoded       Boolean  @default(false)
  isDuplicate     Boolean  @default(false)
  riskScore       Float    @default(0)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  claim           Claim    @relation(fields: [claimId], references: [id], onDelete: Cascade)

  @@map("claim_line_items")
}

// Fraud Detection Alerts
model FraudAlert {
  id              String      @id @default(cuid())
  claimId         String
  providerId      String?
  
  alertType       FraudType
  severity        RiskLevel
  confidence      Float       // 0-100 confidence score
  description     String
  details         Json?       // Detailed analysis results
  
  // Detection metadata
  detectionModel  String      // Which AI/model detected this
  detectionDate   DateTime    @default(now())
  
  // Resolution
  isResolved      Boolean     @default(false)
  resolvedBy      String?
  resolution      String?
  resolvedAt      DateTime?
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  claim           Claim?        @relation(fields: [claimId], references: [id])
  provider        Provider?     @relation(fields: [providerId], references: [id])

  @@map("fraud_alerts")
}

// Investigation Management
model Investigation {
  id              String              @id @default(cuid())
  caseNumber      String              @unique
  claimId         String?             @unique
  providerId      String?
  companyId       String
  
  title           String
  description     String
  status          InvestigationStatus @default(NEW)
  priority        RiskLevel           @default(MEDIUM)
  assignedTo      String?             // User ID
  
  // Timeline
  openedAt        DateTime            @default(now())
  assignedAt      DateTime?
  closedAt        DateTime?
  
  // Findings
  findings        String?
  totalRecovered  Decimal?            @default(0)
  fraudConfirmed Boolean             @default(false)
  fraudTypes      FraudType[]
  
  // Metadata
  createdBy       String              // User ID
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  assignee        User?               @relation("InvestigationAssignee", fields: [assignedTo], references: [id])
  creator         User                @relation("InvestigationCreator", fields: [createdBy], references: [id])
  company         Company             @relation(fields: [companyId], references: [id])
  claim           Claim?              @relation("ClaimInvestigations", fields: [claimId], references: [id])
  provider        Provider?           @relation("ProviderInvestigations", fields: [providerId], references: [id])
  notes           InvestigationNote[]
  documents       InvestigationDocument[]

  @@map("investigations")
}

// Investigation Notes
model InvestigationNote {
  id              String   @id @default(cuid())
  investigationId String
  userId          String
  note            String
  isInternal      Boolean  @default(false)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  investigation    Investigation @relation(fields: [investigationId], references: [id], onDelete: Cascade)
  user            User          @relation(fields: [userId], references: [id])

  @@map("investigation_notes")
}

// Investigation Documents
model InvestigationDocument {
  id              String   @id @default(cuid())
  investigationId String
  fileName        String
  fileType        String
  fileSize        Int
  filePath        String
  description     String?
  
  uploadedBy      String   // User ID
  createdAt       DateTime @default(now())

  investigation    Investigation @relation(fields: [investigationId], references: [id], onDelete: Cascade)

  @@map("investigation_documents")
}

// Provider Network Analysis
model ProviderNetwork {
  id              String   @id @default(cuid())
  providerId1     String
  providerId2     String
  
  relationshipType String  // REFERRAL, SHARED_ADDRESS, SHARED_PHONE, etc.
  strength        Float   // 0-1 relationship strength
  claimFrequency  Int     @default(0)
  totalAmount     Decimal @default(0)
  
  // Fraud indicators
  isSuspicious    Boolean  @default(false)
  riskScore       Float    @default(0)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  provider1       Provider @relation("ProviderNetwork1", fields: [providerId1], references: [id])
  provider2       Provider @relation("ProviderNetwork2", fields: [providerId2], references: [id])

  @@map("provider_networks")
}

// Claim Audit Trail
model ClaimAuditLog {
  id          String   @id @default(cuid())
  claimId     String
  userId      String?
  action      String   // CREATED, UPDATED, FLAGGED, APPROVED, REJECTED, etc.
  oldValue    Json?
  newValue    Json?
  reason      String?
  
  createdAt   DateTime @default(now())

  claim       Claim    @relation(fields: [claimId], references: [id], onDelete: Cascade)

  @@map("claim_audit_logs")
}
